<!DOCTYPE html>
<html lang="fr-fr">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile" hreflang="fr">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Protecting a shared Docker socket using a Golang reverse-proxy (1/4) - ben's lab
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="/css/poole.css">
  <link rel="stylesheet" type="text/css" href="/css/syntax.css">
  <link rel="stylesheet" type="text/css" href="/css/hyde.css">
  <link rel="stylesheet" type="text/css" href="/css/style.css">
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Signika:600">
  <link rel="stylesheet" type="text/css" href="/css/print.css" media="print">
  <!-- Icons -->

  <link rel="apple-touch-icon" sizes="57x57" href="/assets/icones/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/icones/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/icones/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/icones/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/icones/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/icones/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/icones/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/icones/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icones/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/assets/icones/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icones/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/assets/icones/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/icones/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/res/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/assets/icones/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- RSS -->
  <link type="application/atom+xml" rel="alternate" href="/feed.xml" title="ben's lab" />

  <script src="/assets/res/jquery-3.1.0.min.js"></script>
  <!-- Begin Jekyll SEO tag v2.5.0 -->
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Protecting a shared Docker socket using a Golang reverse-proxy (1/4)" />
<meta name="author" content="Ben" />
<meta property="og:locale" content="en_EN" />
<meta name="description" content="Protecting a shared Docker socket using a Golang reverse-proxy" />
<meta property="og:description" content="Protecting a shared Docker socket using a Golang reverse-proxy" />
<link rel="canonical" href="/golang-reverse-proxy-1-4/" />
<meta property="og:url" content="/golang-reverse-proxy-1-4/" />
<meta property="og:site_name" content="ben’s lab" />
<meta property="og:image" content="/assets/uploads/2018/09/golang_and_docker.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-09-16T14:38:43-05:00" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/assets/icones/logo.png"},"name":"Ben"},"@type":"BlogPosting","headline":"Protecting a shared Docker socket using a Golang reverse-proxy (1/4)","dateModified":"2018-09-16T14:38:43-05:00","datePublished":"2018-09-16T14:38:43-05:00","url":"/golang-reverse-proxy-1-4/","mainEntityOfPage":{"@type":"WebPage","@id":"/golang-reverse-proxy-1-4/"},"image":"/assets/uploads/2018/09/golang_and_docker.png","author":{"@type":"Person","name":"Ben"},"description":"Protecting a shared Docker socket using a Golang reverse-proxy","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <img id="site-logo" src="/assets/icones/logo.png" alt="logo" title="logo" />
        <a href="/">
          ben's lab
        </a>
      </h1>
      <p class="lead">Appsec & DevSecOps</p>
    </div>

    <div class="sidebar-section">
        <nav class="sidebar-nav">
          <a class="sidebar-nav-item" href="/">Articles</a>
    
          
          
            
              
                <a class="sidebar-nav-item" href="/about/">About</a>
              
            
          
            
              
                <a class="sidebar-nav-item" href="/archives.html">Archives</a>
              
            
          
            
          
            
              
            
          
            
          
            
          
            
          
        </nav>
    </div>

    <div class="sidebar-section">
        <p>Favorites</p>
        <a href="https://www.zenk-security.com" target="_blank">Zenk-Security</a><br />
    </div>

    <p class="sidebar-copyright">&copy; 2018. All rights reserved.</p>
    <div class="sidebar-social">
    <ul>
      <li><a href="https://github.com/ben-appsec" title="Github" target="_blank"><img title="Github" alt="Github" src="/assets/icones/social/github.png" /></a></li>
      <li><a href="/feed.xml" title="RSS" target="_blank"><img title="RSS" alt="RSS" src="/assets/icones/social/rss.png" /></a></li>
    </ul>
    </div>
  </div>
</div>


    <div class="content container">
      <div class="post">
  
  <div class="post-cover">
    <img src="/assets/uploads/2018/09/golang_and_docker.png" alt="Protecting a shared Docker socket using a Golang reverse-proxy (1/4)" title="Protecting a shared Docker socket using a Golang reverse-proxy (1/4)" />
  </div>
  
  <h1 class="post-title">Protecting a shared Docker socket using a Golang reverse-proxy (1/4)</h1>
  <div class="post-info">
      <p class="alignleft">16 Sep 2018 <a class="post-comments-count" href="http:///golang-reverse-proxy-1-4/#disqus_thread"></a></p>
      <p class="alignright">Author : <strong>Ben</strong></p>
  </div>

  <article>
  <h2 id="introduction">Introduction</h2>

<p>If you already worked a bit with Docker, maybe did you end-up in a situation were you needed to launch/create/manage a new container <strong>from</strong> an already existing one. For example, when you are running a dockerized Jenkins instance and need to create ephemeral containers in your pipeline to perform build tasks.</p>

<p>In such case, a quick Google search will offers you two main options :</p>
<ul>
  <li>
    <p><strong>Docker inside Docker (DinD) :</strong> you perform a full Docker installation within you container. Basically, you run Docker on top of another Docker. I’m not a big fan of this approach and some people much more knowledgeable than me have explained <a href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">why it might be a bad idea</a> (spoiler: filesystem issues and risks of corruption). This options however seems to remain relevant in some cases, for instance if you are using <a href="https://applatix.com/case-docker-docker-kubernetes-part/">Kubernetes</a>.</p>
  </li>
  <li>
    <p><strong>Docker outside Docker (DooD) :</strong> you share the Docker socket of the host with your hosted container.</p>
  </li>
</ul>

<p><code class="highlighter-rouge">docker run -ti --rm -v /var/run/docker.sock:/var/run/docker.sock alpine</code></p>

<p>Once inside the container, performing request to the docker socket become as simple as installing curl and doing :</p>

<p><code class="highlighter-rouge">curl --unix-socket /var/run/docker.sock http://localhost/containers/json</code></p>

<p>Obviously, you can also install the Docker cli for a user experience identical to the one you have on the host.</p>

<p>In my case, I’m running my containers on a small dedicated server using Docker compose. Mainly to perform per commit build jobs on a couple of open-source projects I follow. So DinD doesn’t seems like a good option.</p>

<p>This left us with the DooD approach. However, as a former “offensive security” guy, I can’t accept to break the isolation between my containers and my host so easily. Indeed, in case of compromising of the container with access to the Docker socket, getting root access on the host can be easily achieved.</p>

<p>All  an attacker would have to do is to download the standalone <a href="https://download.docker.com/linux/static/stable/x86_64/">docker client</a>, launch a new busybox container (running by default as root) mapping the root of the host to a directory, and then chroot into it :</p>

<p><code class="highlighter-rouge">docker run -u 0 -ti --rm -v /:/media/host/ busybox chroot /media/host</code></p>

<p><em>Note : This is the exact same reason why it is considered that being in the docker group is equal to have root privilege. It works from the host too.</em></p>

<h2 id="securing-the-docker-socket-using-nginx-">Securing the Docker socket using Nginx ?</h2>

<p>When I saw that the Docker socket gave access to a Web API, my first though was “reverse-proxy”. If you are not familiar with this concept, a reverse-proxy stand between a web server and its client and forward their requests to it. A reverse-proxy also allow to perform caching, load-balancing and… requests filtering ! To solve our issue, we can map our docker socket to a reverse-proxy container, configure our docker client to work with a remote socket and filter its HTTP requests to only allow what we want.</p>

<p><img src="assets/uploads/2018/09/schema-reverse-proxy.jpg" alt="Static Library Link" /></p>

<p>One of the most commonly used reverse proxy is Nginx, which happens to have a ready to use official image on <a href="https://hub.docker.com/_/nginx/">Dockerhub</a>. Neat right ? No.</p>

<p>By doing so, I basically move my risk of compromising from my Jenkins container to my Nginx container. The attack surface is reduced (since Jenkins is <a href="https://www.cvedetails.com/product/34004/Jenkins-Jenkins.html?vendor_id=15865">not realy</a> the most secure software ever), but I still end-up with a full-sized docker container, either based on alpine or debian stretch, running a service with much more features than actually needed.</p>

<p>In some (most ?) cases it may seems like an acceptable solution, but let’s get paranoid and see how we can do it better.</p>

<h2 id="scratch-images-and-golang-to-the-rescue">Scratch images and Golang to the rescue</h2>

<p>A neat way to have an as empty as possible docker image is to build it “FROM scratch”, which basicaly means that your image will <a href="https://embano1.github.io/post/scratch/">“only”</a> contains what you put in it. No <code class="highlighter-rouge">sh</code>, no <code class="highlighter-rouge">/bin</code>, no <code class="highlighter-rouge">/lib</code>, no <code class="highlighter-rouge">thing</code>. The first question that should come up to your mind is : <em>What about dependencies ?</em></p>

<p>If you are coding in Java you need the JVM, if you are coding in Python you need the Python interpreter and if you are coding in C/C++ you have to wear your original <em>Jurassic Park</em> t-shirt and code with <em>Stranger Things</em> in the background for maximum efficiency. We don’t want that.</p>

<p>Luckily, Golang is a language offering just the level of abstraction we need to code a reverse-proxy painlessly while offering all the capabilities of a compiled language, including <strong>static compilation</strong>.</p>

<p><img src="assets/uploads/2018/09/StaticLibraryLink.png" alt="Static Library Link" /></p>

<p>Static compilation is a compilation process resulting in a standalone binary embeding all its dependencies. For instance, a software developed in C and statically compiled won’t rely on the system <code class="highlighter-rouge">libc</code> but the one it as been compiled with. The same thing can be easily achieve in Go :</p>

<p><code class="highlighter-rouge">CGO_ENABLED=0 GOOS=linux go build -a -ldflags '-extldflags "-static"' src/reverse-proxy.go</code></p>

<h2 id="we-got-a-plan-">We got a plan !</h2>

<p>With this information in mind, all me now have to do is apply the classic “make it work, then make it better” method :</p>
<ol>
  <li>Create a basic Go reverse-proxy and move it to a scratch image</li>
  <li>Add filtering capabilities</li>
  <li>Add HTTPS support, client authentication and per client filtering policies</li>
</ol>

<p>Each of those points will be the subject of dedicated blog posts in this serie.</p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/">https://jpetazzo.github.io/2015/09/03/do-not-use-docker-in-docker-for-ci/</a></li>
  <li><a href="https://applatix.com/case-docker-docker-kubernetes-part/">https://applatix.com/case-docker-docker-kubernetes-part/</a></li>
  <li><a href="https://embano1.github.io/post/scratch/">https://embano1.github.io/post/scratch/</a></li>
  <li><a href="https://www.bogotobogo.com/cplusplus/libraries.php">https://www.bogotobogo.com/cplusplus/libraries.php</a> [Static Library Link schema]</li>
</ul>

  </article>
</div>

<div class="related">
  <h2>Related Articles</h2>
  <ul class="related-posts">
    
  </ul>
</div>

<div id="disqus_thread"></div>


    </div>
  <script src="/assets/res/anchor.min.js"></script>
  <script src="/assets/res/script.js"></script>
  </body>
</html>
